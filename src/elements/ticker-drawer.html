<link rel='import' href='../../components/paper-item/paper-icon-item.html'>
<link rel='import' href='../../components/paper-item/paper-item-body.html'>
<link rel='import' href='../../components/paper-button/paper-button.html'>
<link rel='import' href='common/ticker-avatar.html'>
<link rel='import' href='common/ticker-repo-name.html'>

<style>
ticker-drawer {
  display: block;
  -moz-user-select: none;
  -ms-user-select: none;
  -webkit-user-select: none;
  user-select: none;
}
</style>
<dom-module id='ticker-drawer'>
  <template>
    <div class='t-align-center'>
      <paper-button class='l-margin-2' hidden$='[[user]]' on-tap='_onSignin'>Signin to Github</paper-button>
    </div>
    <template is='dom-repeat' items='[[_favoritedSources]]'>
      <paper-icon-item class='l-position-relative' icon-width='45px'>
        <ticker-avatar item-icon source='[[item]]'></ticker-avatar>
        <paper-item-body two-line on-tap='_onSourceSelect'>
          <span>[[item.login]]</span>
          <ticker-repo-name repo-name='[[item.full_name]]'
                            hidden='[[!item.full_name]]'></ticker-repo-name>
          <div secondary
               class='c-gray-dark l-padding-r4'>[[item.description]]</div>
        </paper-item-body>
      </paper-icon-item>
    </template>
  </template>
</dom-module>
<script>
Polymer({
  is: 'ticker-drawer',
  properties:{
    _favoritedSources:{
      type:Array
    }
  },
  behaviors:[
    syncState(['favoritedSources', 'user'])
  ],
  observers:[
    '_onFavoritedSourcesChange(favoritedSources)'
  ],
  _onSignin:function(){
    appState.fire('authWithGithub');
  },
  _onFavoritedSourcesChange:function(){
    // TODO(pwong): When selecting a new source, the statechart unfortunately
    //              exits and re-enters causing `favoritedSources` to flicker.
    this.debounce('favoritedSources', function(){
      this._favoritedSources = this.favoritedSources;
    }, 100);
  },
  _onSourceSelect:function(e){
    var userRepo = e.model.item.displayName.split('/');
    setTimeout(function(){
      appState.fire(
        userRepo[1] ? 'gotoGithubRepoSource' : 'gotoGithubUserSource',
        {sourceUser:userRepo[0], sourceRepo:userRepo[1]}
      );
    }, 100);
  }
})
</script>
